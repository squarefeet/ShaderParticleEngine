<!DOCTYPE html>

<html>
<head>
  <title>shaders.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="../../docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">
              
                
                <a class="source" href="../constants/distributions.html">
                  src/constants/distributions.js
                </a>
              
                
                <a class="source" href="../constants/globals.html">
                  src/constants/globals.js
                </a>
              
                
                <a class="source" href="../constants/typeSizeMap.html">
                  src/constants/typeSizeMap.js
                </a>
              
                
                <a class="source" href="../constants/valueTypes.html">
                  src/constants/valueTypes.js
                </a>
              
                
                <a class="source" href="../core/Emitter.html">
                  src/core/Emitter.js
                </a>
              
                
                <a class="source" href="../core/Group.html">
                  src/core/Group.js
                </a>
              
                
                <a class="source" href="../core/utils.html">
                  src/core/utils.js
                </a>
              
                
                <a class="source" href="../helpers/ShaderAttribute.html">
                  src/helpers/ShaderAttribute.js
                </a>
              
                
                <a class="source" href="../helpers/TypedArrayHelper.html">
                  src/helpers/TypedArrayHelper.js
                </a>
              
                
                <a class="source" href="shaderChunks.html">
                  src/shaders/shaderChunks.js
                </a>
              
                
                <a class="source" href="shaders.html">
                  src/shaders/shaders.js
                </a>
              
            </div>
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>shaders.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> THREE <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;three&#x27;</span>;
<span class="hljs-keyword">import</span> shaderChunks <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./shaderChunks&#x27;</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
	<span class="hljs-attr">vertex</span>: [
		shaderChunks.defines,
		shaderChunks.uniforms,
		shaderChunks.attributes,
		shaderChunks.varyings,

		THREE.ShaderChunk.common,
		THREE.ShaderChunk.logdepthbuf_pars_vertex,
		THREE.ShaderChunk.fog_pars_vertex,

		shaderChunks.branchAvoidanceFunctions,
		shaderChunks.unpackColor,
		shaderChunks.unpackRotationAxis,
		shaderChunks.floatOverLifetime,
		shaderChunks.colorOverLifetime,
		shaderChunks.paramFetchingFunctions,
		shaderChunks.forceFetchingFunctions,
		shaderChunks.rotationFunctions,

		<span class="hljs-string">&#x27;void main() {&#x27;</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Setup…</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-string">&#x27;    highp float age = getAge();&#x27;</span>,
		<span class="hljs-string">&#x27;    highp float alive = getAlive();&#x27;</span>,
		<span class="hljs-string">&#x27;    highp float maxAge = getMaxAge();&#x27;</span>,
		<span class="hljs-string">&#x27;    highp float positionInTime = (age / maxAge);&#x27;</span>,
		<span class="hljs-string">&#x27;    highp float isAlive = when_gt( alive, 0.0 );&#x27;</span>,

		<span class="hljs-string">&#x27;    #ifdef SHOULD_WIGGLE_PARTICLES&#x27;</span>,
		<span class="hljs-string">&#x27;        float wiggleAmount = positionInTime * getWiggle();&#x27;</span>,
		<span class="hljs-string">&#x27;        float wiggleSin = isAlive * sin( wiggleAmount );&#x27;</span>,
		<span class="hljs-string">&#x27;        float wiggleCos = isAlive * cos( wiggleAmount );&#x27;</span>,
		<span class="hljs-string">&#x27;    #endif&#x27;</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Forces</p>

            </div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Get forces &amp; position</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-string">&#x27;    vec3 vel = getVelocity( age );&#x27;</span>,
		<span class="hljs-string">&#x27;    vec3 accel = getAcceleration( age );&#x27;</span>,
		<span class="hljs-string">&#x27;    vec3 force = vec3( 0.0 );&#x27;</span>,
		<span class="hljs-string">&#x27;    vec3 pos = vec3( position );&#x27;</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Calculate the required drag to apply to the forces.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-string">&#x27;    float drag = 1.0 - (positionInTime * 0.5) * acceleration.w;&#x27;</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Integrate forces…</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-string">&#x27;    force += vel;&#x27;</span>,
		<span class="hljs-string">&#x27;    force *= drag;&#x27;</span>,
		<span class="hljs-string">&#x27;    force += accel * age;&#x27;</span>,
		<span class="hljs-string">&#x27;    pos += force;&#x27;</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Wiggly wiggly wiggle!</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-string">&#x27;    #ifdef SHOULD_WIGGLE_PARTICLES&#x27;</span>,
		<span class="hljs-string">&#x27;        pos.x += wiggleSin;&#x27;</span>,
		<span class="hljs-string">&#x27;        pos.y += wiggleCos;&#x27;</span>,
		<span class="hljs-string">&#x27;        pos.z += wiggleSin;&#x27;</span>,
		<span class="hljs-string">&#x27;    #endif&#x27;</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Rotate the emitter around it’s central point</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-string">&#x27;    #ifdef SHOULD_ROTATE_PARTICLES&#x27;</span>,
		<span class="hljs-string">&#x27;        pos = getRotation( pos, positionInTime );&#x27;</span>,
		<span class="hljs-string">&#x27;    #endif&#x27;</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Convert pos to a world-space value</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-string">&#x27;    vec4 mvPosition = modelViewMatrix * vec4( pos, 1.0 );&#x27;</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Determine point size.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-string">&#x27;    highp float pointSize = getFloatOverLifetime( positionInTime, size ) * isAlive;&#x27;</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Determine perspective</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-string">&#x27;    #ifdef HAS_PERSPECTIVE&#x27;</span>,
		<span class="hljs-string">&#x27;        float perspective = scale / length( mvPosition.xyz );&#x27;</span>,
		<span class="hljs-string">&#x27;    #else&#x27;</span>,
		<span class="hljs-string">&#x27;        float perspective = 1.0;&#x27;</span>,
		<span class="hljs-string">&#x27;    #endif&#x27;</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Apply perpective to pointSize value</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-string">&#x27;    float pointSizePerspective = pointSize * perspective;&#x27;</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Appearance</p>

            </div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Determine color and opacity for this particle</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-string">&#x27;    #ifdef COLORIZE&#x27;</span>,
		<span class="hljs-string">&#x27;       vec3 c = isAlive * getColorOverLifetime(&#x27;</span>,
		<span class="hljs-string">&#x27;           positionInTime,&#x27;</span>,
		<span class="hljs-string">&#x27;           unpackColor( color.x ),&#x27;</span>,
		<span class="hljs-string">&#x27;           unpackColor( color.y ),&#x27;</span>,
		<span class="hljs-string">&#x27;           unpackColor( color.z ),&#x27;</span>,
		<span class="hljs-string">&#x27;           unpackColor( color.w )&#x27;</span>,
		<span class="hljs-string">&#x27;       );&#x27;</span>,
		<span class="hljs-string">&#x27;    #else&#x27;</span>,
		<span class="hljs-string">&#x27;       vec3 c = vec3(1.0);&#x27;</span>,
		<span class="hljs-string">&#x27;    #endif&#x27;</span>,

		<span class="hljs-string">&#x27;    float o = isAlive * getFloatOverLifetime( positionInTime, opacity );&#x27;</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Assign color to vColor varying.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-string">&#x27;    vColor = vec4( c, o );&#x27;</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Determine angle</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-string">&#x27;    #ifdef SHOULD_ROTATE_TEXTURE&#x27;</span>,
		<span class="hljs-string">&#x27;        vAngle = isAlive * getFloatOverLifetime( positionInTime, angle );&#x27;</span>,
		<span class="hljs-string">&#x27;    #endif&#x27;</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>If this particle is using a sprite-sheet as a texture, we’ll have to figure out
what frame of the texture the particle is using at it’s current position in time.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-string">&#x27;    #ifdef SHOULD_CALCULATE_SPRITE&#x27;</span>,
		<span class="hljs-string">&#x27;        float framesX = textureAnimation.x;&#x27;</span>,
		<span class="hljs-string">&#x27;        float framesY = textureAnimation.y;&#x27;</span>,
		<span class="hljs-string">&#x27;        float loopCount = textureAnimation.w;&#x27;</span>,
		<span class="hljs-string">&#x27;        float totalFrames = textureAnimation.z;&#x27;</span>,
		<span class="hljs-string">&#x27;        float frameNumber = mod( (positionInTime * loopCount) * totalFrames, totalFrames );&#x27;</span>,

		<span class="hljs-string">&#x27;        float column = floor(mod( frameNumber, framesX ));&#x27;</span>,
		<span class="hljs-string">&#x27;        float row = floor( (frameNumber - column) / framesX );&#x27;</span>,

		<span class="hljs-string">&#x27;        float columnNorm = column / framesX;&#x27;</span>,
		<span class="hljs-string">&#x27;        float rowNorm = row / framesY;&#x27;</span>,

		<span class="hljs-string">&#x27;        vSpriteSheet.x = 1.0 / framesX;&#x27;</span>,
		<span class="hljs-string">&#x27;        vSpriteSheet.y = 1.0 / framesY;&#x27;</span>,
		<span class="hljs-string">&#x27;        vSpriteSheet.z = columnNorm;&#x27;</span>,
		<span class="hljs-string">&#x27;        vSpriteSheet.w = rowNorm;&#x27;</span>,
		<span class="hljs-string">&#x27;    #endif&#x27;</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Write values</p>

            </div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Set PointSize according to size at current point in time.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-string">&#x27;    gl_PointSize = pointSizePerspective;&#x27;</span>,
		<span class="hljs-string">&#x27;    gl_Position = projectionMatrix * mvPosition;&#x27;</span>,

		THREE.ShaderChunk.logdepthbuf_vertex,
		THREE.ShaderChunk.fog_vertex,

		<span class="hljs-string">&#x27;}&#x27;</span>,
	].join( <span class="hljs-string">&#x27;\n&#x27;</span> ),

	<span class="hljs-attr">fragment</span>: [
		shaderChunks.uniforms,

		THREE.ShaderChunk.common,
		THREE.ShaderChunk.fog_pars_fragment,
		THREE.ShaderChunk.logdepthbuf_pars_fragment,

		shaderChunks.varyings,

		shaderChunks.branchAvoidanceFunctions,

		<span class="hljs-string">&#x27;void main() {&#x27;</span>,
		<span class="hljs-string">&#x27;    vec3 outgoingLight = vColor.xyz;&#x27;</span>,
		<span class="hljs-string">&#x27;    &#x27;</span>,
		<span class="hljs-string">&#x27;    #ifdef ALPHATEST&#x27;</span>,
		<span class="hljs-string">&#x27;       if ( vColor.w &lt; float(ALPHATEST) ) discard;&#x27;</span>,
		<span class="hljs-string">&#x27;    #endif&#x27;</span>,

		shaderChunks.rotateTexture,

		THREE.ShaderChunk.logdepthbuf_fragment,

		<span class="hljs-string">&#x27;    outgoingLight = vColor.xyz * rotatedTexture.xyz;&#x27;</span>,
		<span class="hljs-string">&#x27;    gl_FragColor = vec4( outgoingLight.xyz, rotatedTexture.w * vColor.w );&#x27;</span>,

		THREE.ShaderChunk.fog_fragment,

		<span class="hljs-string">&#x27;}&#x27;</span>,
	].join( <span class="hljs-string">&#x27;\n&#x27;</span> ),
};</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
