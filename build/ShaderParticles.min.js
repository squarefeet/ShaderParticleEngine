/* Shader-Particles 0.7.8
 * 
 * (c) 2013 Luke Moody (http://www.github.com/squarefeet) & Lee Stemkoski (http://www.adelphi.edu/~stemkoski/)
 *     Based on Lee Stemkoski's original work (https://github.com/stemkoski/stemkoski.github.com/blob/master/Three.js/js/ParticleEngine.js).
 *
 * Shader-Particles may be freely distributed under the MIT license (See LICENSE.txt at root of this repository.)
 */
module.exports=function(a){var b={};b.utils={randomVector3:function(b,c){var d=new a.Vector3;return d.copy(b),d.x+=Math.random()*c.x-c.x/2,d.y+=Math.random()*c.y-c.y/2,d.z+=Math.random()*c.z-c.z/2,d},randomColor:function(b,c){var d=new a.Color;return d.copy(b),d.r+=Math.random()*c.x-c.x/2,d.g+=Math.random()*c.y-c.y/2,d.b+=Math.random()*c.z-c.z/2,d.r=Math.max(0,Math.min(d.r,1)),d.g=Math.max(0,Math.min(d.g,1)),d.b=Math.max(0,Math.min(d.b,1)),d},randomFloat:function(a,b){return a+b*(Math.random()-.5)},randomVector3OnSphere:function(b,c,d,e,f){var g=2*Math.random()-1,h=6.2832*Math.random(),i=Math.sqrt(1-g*g),j=new a.Vector3(i*Math.cos(h),i*Math.sin(h),g),k=this._randomFloat(c,d);return f&&(k=Math.round(k/f)*f),j.multiplyScalar(k),e&&j.multiply(e),j.add(b),j},randomVector3OnDisk:function(b,c,d,e,f){var g=6.2832*Math.random(),h=this._randomFloat(c,d);f&&(h=Math.round(h/f)*f);var i=new a.Vector3(Math.cos(g),Math.sin(g),0).multiplyScalar(h);return e&&i.multiply(e),i.add(b),i},randomVelocityVector3OnSphere:function(b,c,d,e,f){var g=(new a.Vector3).subVectors(b,c);return g.normalize().multiplyScalar(Math.abs(this._randomFloat(d,e))),f&&g.multiply(f),g},randomizeExistingVector3:function(a,b,c){a.copy(b),a.x+=Math.random()*c.x-c.x/2,a.y+=Math.random()*c.y-c.y/2,a.z+=Math.random()*c.z-c.z/2},randomizeExistingColor:function(a,b,c){a.copy(b),a.r+=Math.random()*c.x-c.x/2,a.g+=Math.random()*c.y-c.y/2,a.b+=Math.random()*c.z-c.z/2,a.r=Math.max(0,Math.min(a.r,1)),a.g=Math.max(0,Math.min(a.g,1)),a.b=Math.max(0,Math.min(a.b,1))},randomizeExistingVector3OnSphere:function(a,b,c,d,e,f){var g=2*Math.random()-1,h=6.2832*Math.random(),i=Math.sqrt(1-g*g),j=this._randomFloat(c,d);f&&(j=Math.round(j/f)*f),a.set(i*Math.cos(h)*j,i*Math.sin(h)*j,g*j).multiply(e),a.add(b)},randomizeExistingVector3OnDisk:function(a,b,c,d,e,f){var g=6.2832*Math.random(),h=Math.abs(this._randomFloat(c,d));f&&(h=Math.round(h/f)*f),a.set(Math.cos(g),Math.sin(g),0).multiplyScalar(h),e&&a.multiply(e),a.add(b)},randomizeExistingVelocityVector3OnSphere:function(a,b,c,d,e){a.copy(c).sub(b).normalize().multiplyScalar(Math.abs(this._randomFloat(d,e)))},generateID:function(){var a="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx";return a=a.replace(/[xy]/g,function(a){var b=Math.random(),c=16*b|0,d="x"===a?c:3&c|8;return d.toString(16)})}},b.Group=function(c){var d=this;d.fixedTimeStep=parseFloat("number"==typeof c.fixedTimeStep?c.fixedTimeStep:.016),d.maxAge=parseFloat(c.maxAge||3),d.texture=c.texture||null,d.hasPerspective=parseInt("number"==typeof c.hasPerspective?c.hasPerspective:1,10),d.colorize=parseInt("number"==typeof c.colorize?c.colorize:1,10),d.blending="number"==typeof c.blending?c.blending:a.AdditiveBlending,d.transparent="number"==typeof c.transparent?c.transparent:1,d.alphaTest="number"==typeof c.alphaTest?c.alphaTest:.5,d.depthWrite=c.depthWrite||!1,d.depthTest=c.depthTest||!0,d.uniforms={duration:{type:"f",value:d.maxAge},texture:{type:"t",value:d.texture},hasPerspective:{type:"i",value:d.hasPerspective},colorize:{type:"i",value:d.colorize}},d.attributes={acceleration:{type:"v3",value:[]},velocity:{type:"v3",value:[]},alive:{type:"f",value:[]},age:{type:"f",value:[]},size:{type:"v3",value:[]},angle:{type:"v4",value:[]},colorStart:{type:"c",value:[]},colorMiddle:{type:"c",value:[]},colorEnd:{type:"c",value:[]},opacity:{type:"v3",value:[]}},d.emitters=[],d._pool=[],d._poolCreationSettings=null,d._createNewWhenPoolEmpty=0,d.maxAgeMilliseconds=1e3*d.maxAge,d.geometry=new a.Geometry,d.material=new a.ShaderMaterial({uniforms:d.uniforms,attributes:d.attributes,vertexShader:b.shaders.vertex,fragmentShader:b.shaders.fragment,blending:d.blending,transparent:d.transparent,alphaTest:d.alphaTest,depthWrite:d.depthWrite,depthTest:d.depthTest}),d.mesh=new a.PointCloud(d.geometry,d.material),d.mesh.dynamic=!0},b.Group.prototype={_flagUpdate:function(){var a=this;return a.attributes.age.needsUpdate=!0,a.attributes.alive.needsUpdate=!0,a.attributes.angle.needsUpdate=!0,a.attributes.velocity.needsUpdate=!0,a.attributes.acceleration.needsUpdate=!0,a.geometry.verticesNeedUpdate=!0,a},addEmitter:function(b){var c=this;b.particlesPerSecond=b.duration?b.particleCount/(c.maxAge<b.duration?c.maxAge:b.duration)|0:b.particleCount/c.maxAge|0;var d=c.geometry.vertices,e=d.length,f=b.particleCount+e,g=c.attributes,h=g.acceleration.value,i=g.velocity.value,j=g.alive.value,k=g.age.value,l=g.size.value,m=g.angle.value,n=g.colorStart.value,o=g.colorMiddle.value,p=g.colorEnd.value,q=g.opacity.value;b.particleIndex=parseFloat(e);for(var r=e;f>r;++r)"sphere"===b.type?(d[r]=c._randomVector3OnSphere(b.position,b.radius,b.radiusSpread,b.radiusScale,b.radiusSpreadClamp),i[r]=c._randomVelocityVector3OnSphere(d[r],b.position,b.speed,b.speedSpread)):"disk"===b.type?(d[r]=c._randomVector3OnDisk(b.position,b.radius,b.radiusSpread,b.radiusScale,b.radiusSpreadClamp),i[r]=c._randomVelocityVector3OnSphere(d[r],b.position,b.speed,b.speedSpread)):(d[r]=c._randomVector3(b.position,b.positionSpread),i[r]=c._randomVector3(b.velocity,b.velocitySpread)),h[r]=c._randomVector3(b.acceleration,b.accelerationSpread),l[r]=new a.Vector3(Math.abs(c._randomFloat(b.sizeStart,b.sizeStartSpread)),Math.abs(c._randomFloat(b.sizeMiddle,b.sizeMiddleSpread)),Math.abs(c._randomFloat(b.sizeEnd,b.sizeEndSpread))),m[r]=new a.Vector4(c._randomFloat(b.angleStart,b.angleStartSpread),c._randomFloat(b.angleMiddle,b.angleMiddleSpread),c._randomFloat(b.angleEnd,b.angleEndSpread),b.angleAlignVelocity?1:0),k[r]=0,j[r]=b.isStatic?1:0,n[r]=c._randomColor(b.colorStart,b.colorStartSpread),o[r]=c._randomColor(b.colorMiddle,b.colorMiddleSpread),p[r]=c._randomColor(b.colorEnd,b.colorEndSpread),q[r]=new a.Vector3(Math.abs(c._randomFloat(b.opacityStart,b.opacityStartSpread)),Math.abs(c._randomFloat(b.opacityMiddle,b.opacityMiddleSpread)),Math.abs(c._randomFloat(b.opacityEnd,b.opacityEndSpread)));return b.verticesIndex=parseFloat(e),b.attributes=g,b.vertices=c.geometry.vertices,b.maxAge=c.maxAge,b.__id=c._generateID(),b.isStatic||c.emitters.push(b),c},removeEmitter:function(a){var c,d=this.emitters;if(a instanceof b.Emitter)c=a.__id;else{if("string"!=typeof a)return void console.warn("Invalid emitter or emitter ID passed to SPE.Group#removeEmitter.");c=a}for(var e=0,f=d.length;f>e;++e)if(d[e].__id===c){d.splice(e,1);break}},tick:function(a){var b=this,c=b.emitters,d=c.length;if(a=a||b.fixedTimeStep,0!==d){for(var e=0;d>e;++e)c[e].tick(a);return b._flagUpdate(),b}},getFromPool:function(){var a=this,c=a._pool,d=a._createNewWhenPoolEmpty;return c.length?c.pop():d?new b.Emitter(a._poolCreationSettings):null},releaseIntoPool:function(a){return a instanceof b.Emitter?(a.reset(),this._pool.unshift(a),this):void console.error("Will not add non-emitter to particle group pool:",a)},getPool:function(){return this._pool},addPool:function(a,c,d){var e,f=this;f._poolCreationSettings=c,f._createNewWhenPoolEmpty=!!d;for(var g=0;a>g;++g)e=new b.Emitter(c),f.addEmitter(e),f.releaseIntoPool(e);return f},_triggerSingleEmitter:function(a){var b=this,c=b.getFromPool();return null===c?void console.log("SPE.Group pool ran out."):(a&&c.position.copy(a),c.enable(),setTimeout(function(){c.disable(),b.releaseIntoPool(c)},b.maxAgeMilliseconds),b)},triggerPoolEmitter:function(a,b){var c=this;if("number"==typeof a&&a>1)for(var d=0;a>d;++d)c._triggerSingleEmitter(b);else c._triggerSingleEmitter(b);return c}};for(var c in b.utils)b.Group.prototype["_"+c]=b.utils[c];b.shaders={vertex:["uniform float duration;","uniform int hasPerspective;","attribute vec3 colorStart;","attribute vec3 colorMiddle;","attribute vec3 colorEnd;","attribute vec3 opacity;","attribute vec3 acceleration;","attribute vec3 velocity;","attribute float alive;","attribute float age;","attribute vec3 size;","attribute vec4 angle;","varying vec4 vColor;","varying float vAngle;","vec4 GetPos() {","vec3 newPos = vec3( position );","vec3 a = acceleration * age;","vec3 v = velocity * age;","v = v + (a * age);","newPos = newPos + v;","vec4 mvPosition = modelViewMatrix * vec4( newPos, 1.0 );","return mvPosition;","}","void main() {","float positionInTime = (age / duration);","float lerpAmount1 = (age / (0.5 * duration));","float lerpAmount2 = ((age - 0.5 * duration) / (0.5 * duration));","float halfDuration = duration / 2.0;","float pointSize = 0.0;","vAngle = 0.0;","if( alive > 0.5 ) {","if( positionInTime < 0.5 ) {","vColor = vec4( mix(colorStart, colorMiddle, lerpAmount1), mix(opacity.x, opacity.y, lerpAmount1) );","}","else {","vColor = vec4( mix(colorMiddle, colorEnd, lerpAmount2), mix(opacity.y, opacity.z, lerpAmount2) );","}","vec4 pos = GetPos();","if( angle[3] == 1.0 ) {","vAngle = -atan(pos.y, pos.x);","}","else if( positionInTime < 0.5 ) {","vAngle = mix( angle.x, angle.y, lerpAmount1 );","}","else {","vAngle = mix( angle.y, angle.z, lerpAmount2 );","}","if( positionInTime < 0.5) {","pointSize = mix( size.x, size.y, lerpAmount1 );","}","else {","pointSize = mix( size.y, size.z, lerpAmount2 );","}","if( hasPerspective == 1 ) {","pointSize = pointSize * ( 300.0 / length( pos.xyz ) );","}","gl_PointSize = pointSize;","gl_Position = projectionMatrix * pos;","}","else {","vColor = vec4( 0.0, 0.0, 0.0, 0.0 );","gl_Position = vec4(1000000000.0, 1000000000.0, 1000000000.0, 0.0);","}","}"].join("\n"),fragment:["uniform sampler2D texture;","uniform int colorize;","varying vec4 vColor;","varying float vAngle;","void main() {","float c = cos(vAngle);","float s = sin(vAngle);","vec2 rotatedUV = vec2(c * (gl_PointCoord.x - 0.5) + s * (gl_PointCoord.y - 0.5) + 0.5,","c * (gl_PointCoord.y - 0.5) - s * (gl_PointCoord.x - 0.5) + 0.5);","vec4 rotatedTexture = texture2D( texture, rotatedUV );","if( colorize == 1 ) {","gl_FragColor = vColor * rotatedTexture;","}","else {","gl_FragColor = rotatedTexture;","}","}"].join("\n")},b.Emitter=function(b){b=b||{};var c=this;c.particleCount="number"==typeof b.particleCount?b.particleCount:100,c.type="cube"===b.type||"sphere"===b.type||"disk"===b.type?b.type:"cube",c.position=b.position instanceof a.Vector3?b.position:new a.Vector3,c.positionSpread=b.positionSpread instanceof a.Vector3?b.positionSpread:new a.Vector3,c.radius="number"==typeof b.radius?b.radius:10,c.radiusSpread="number"==typeof b.radiusSpread?b.radiusSpread:0,c.radiusScale=b.radiusScale instanceof a.Vector3?b.radiusScale:new a.Vector3(1,1,1),c.radiusSpreadClamp="number"==typeof b.radiusSpreadClamp?b.radiusSpreadClamp:0,c.acceleration=b.acceleration instanceof a.Vector3?b.acceleration:new a.Vector3,c.accelerationSpread=b.accelerationSpread instanceof a.Vector3?b.accelerationSpread:new a.Vector3,c.velocity=b.velocity instanceof a.Vector3?b.velocity:new a.Vector3,c.velocitySpread=b.velocitySpread instanceof a.Vector3?b.velocitySpread:new a.Vector3,c.speed=parseFloat("number"==typeof b.speed?b.speed:0),c.speedSpread=parseFloat("number"==typeof b.speedSpread?b.speedSpread:0),c.sizeStart=parseFloat("number"==typeof b.sizeStart?b.sizeStart:1),c.sizeStartSpread=parseFloat("number"==typeof b.sizeStartSpread?b.sizeStartSpread:0),c.sizeEnd=parseFloat("number"==typeof b.sizeEnd?b.sizeEnd:c.sizeStart),c.sizeEndSpread=parseFloat("number"==typeof b.sizeEndSpread?b.sizeEndSpread:0),c.sizeMiddle=parseFloat("undefined"!=typeof b.sizeMiddle?b.sizeMiddle:Math.abs(c.sizeEnd+c.sizeStart)/2),c.sizeMiddleSpread=parseFloat("number"==typeof b.sizeMiddleSpread?b.sizeMiddleSpread:0),c.angleStart=parseFloat("number"==typeof b.angleStart?b.angleStart:0),c.angleStartSpread=parseFloat("number"==typeof b.angleStartSpread?b.angleStartSpread:0),c.angleEnd=parseFloat("number"==typeof b.angleEnd?b.angleEnd:0),c.angleEndSpread=parseFloat("number"==typeof b.angleEndSpread?b.angleEndSpread:0),c.angleMiddle=parseFloat("undefined"!=typeof b.angleMiddle?b.angleMiddle:Math.abs(c.angleEnd+c.angleStart)/2),c.angleMiddleSpread=parseFloat("number"==typeof b.angleMiddleSpread?b.angleMiddleSpread:0),c.angleAlignVelocity=b.angleAlignVelocity||!1,c.colorStart=b.colorStart instanceof a.Color?b.colorStart:new a.Color("white"),c.colorStartSpread=b.colorStartSpread instanceof a.Vector3?b.colorStartSpread:new a.Vector3,c.colorEnd=b.colorEnd instanceof a.Color?b.colorEnd:c.colorStart.clone(),c.colorEndSpread=b.colorEndSpread instanceof a.Vector3?b.colorEndSpread:new a.Vector3,c.colorMiddle=b.colorMiddle instanceof a.Color?b.colorMiddle:(new a.Color).addColors(c.colorStart,c.colorEnd).multiplyScalar(.5),c.colorMiddleSpread=b.colorMiddleSpread instanceof a.Vector3?b.colorMiddleSpread:new a.Vector3,c.opacityStart=parseFloat("undefined"!=typeof b.opacityStart?b.opacityStart:1),c.opacityStartSpread=parseFloat("undefined"!=typeof b.opacityStartSpread?b.opacityStartSpread:0),c.opacityEnd=parseFloat("number"==typeof b.opacityEnd?b.opacityEnd:0),c.opacityEndSpread=parseFloat("undefined"!=typeof b.opacityEndSpread?b.opacityEndSpread:0),c.opacityMiddle=parseFloat("undefined"!=typeof b.opacityMiddle?b.opacityMiddle:Math.abs(c.opacityEnd+c.opacityStart)/2),c.opacityMiddleSpread=parseFloat("number"==typeof b.opacityMiddleSpread?b.opacityMiddleSpread:0),c.duration="number"==typeof b.duration?b.duration:null,c.alive=parseFloat("number"==typeof b.alive?b.alive:1),c.isStatic="number"==typeof b.isStatic?b.isStatic:0,c.particlesPerSecond=0,c.attributes=null,c.vertices=null,c.verticesIndex=0,c.age=0,c.maxAge=0,c.particleIndex=0,c.__id=null,c.userData={}},b.Emitter.prototype={_resetParticle:function(a){var b=this,c=b.type,d=b.positionSpread,e=b.vertices[a],f=b.attributes,g=f.velocity.value[a],h=b.velocitySpread,i=b.accelerationSpread;"cube"===c&&0===d.x&&0===d.y&&0===d.z||"sphere"===c&&0===b.radius||"disk"===c&&0===b.radius?(e.copy(b.position),b._randomizeExistingVector3(g,b.velocity,h),"cube"===c&&b._randomizeExistingVector3(b.attributes.acceleration.value[a],b.acceleration,i)):"cube"===c?(b._randomizeExistingVector3(e,b.position,d),b._randomizeExistingVector3(g,b.velocity,h),b._randomizeExistingVector3(b.attributes.acceleration.value[a],b.acceleration,i)):"sphere"===c?(b._randomizeExistingVector3OnSphere(e,b.position,b.radius,b.radiusSpread,b.radiusScale,b.radiusSpreadClamp),b._randomizeExistingVelocityVector3OnSphere(g,b.position,e,b.speed,b.speedSpread)):"disk"===c&&(b._randomizeExistingVector3OnDisk(e,b.position,b.radius,b.radiusSpread,b.radiusScale,b.radiusSpreadClamp),b._randomizeExistingVelocityVector3OnSphere(g,b.position,e,b.speed,b.speedSpread))},tick:function(a){if(!this.isStatic){for(var b=this,c=b.attributes,d=c.alive.value,e=c.age.value,f=b.verticesIndex,g=b.particleCount,h=f+g,i=b.particlesPerSecond*b.alive,j=i*a,k=b.maxAge,l=b.age,m=b.duration,n=b.particleIndex,o=f;h>o;++o)1===d[o]&&(e[o]+=a),e[o]>=k&&(e[o]=0,d[o]=0);if(0===b.alive)return void(b.age=0);if("number"==typeof m&&l>m)return b.alive=0,void(b.age=0);var p,q=Math.max(Math.min(h,n+j),0),r=0,s=0,t=0|n;for(o=t;q>o;++o)1!==d[o]&&++r;if(0!==r)for(p=a/r,o=t;q>o;++o,++s)1!==d[o]&&(d[o]=1,e[o]=p*s,b._resetParticle(o));b.particleIndex+=j,b.particleIndex<0&&(b.particleIndex=0),n>=f+g&&(b.particleIndex=parseFloat(f)),b.age+=a,b.age<0&&(b.age=0)}},reset:function(a){var b=this;if(b.age=0,b.alive=0,a)for(var c=b.verticesIndex,d=b.verticesIndex+b.particleCount,e=b.attributes,f=e.alive.value,g=e.age.value,h=c;d>h;++h)f[h]=0,g[h]=0;return b},enable:function(){this.alive=1},disable:function(){this.alive=0}};for(var c in b.utils)b.Emitter.prototype["_"+c]=b.utils[c];return b};